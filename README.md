Мониторинг ценовых значений MOEX TQBR котировального списка фаондовой секции Московской биржи.
--------------------------------------------------------- 
!!! ВАЖНО !!!
--------------------------------------------------------- 

--
Для предостережения и предотвращения угона системы и заражения майнерами
  
    До развертывания каких либо приложений, в докере или без, требуется обезопасить ssh, смените порты, выпустите ключи, ограничте ip диапазоны подключения, можно также запретить юзать root ssh
    Сразу же включить firewall и настроить его только на ssh, потом будете добавлять по мере надобности остальные. http, https потребуются для apt upgrade и установки пакетов. После установки контейнеров, разрешите те порты, что будете использовать.

    Если используете VDS и сгенерированный root пользователь от провайдера, то следует его сменить прямо через минуту после
    создания виртуалки. 
    Боты и сканеры буквально сразу взломают ваш сервер, если вы не позаботитесь о том, чтобы его настроить.
    После клонирования репозитория, откройте .env и смените все настройки по умолчанию, до того как разворачивать контейнеры.

    Не рекомендуестя запускать контейнеры от root пользователя,
    или от пользователя, который входит в группу sudo.
    Для этого нужно создать отдельного пользователя и добавить его в группу docker.
    Если боты и вредоносный код всетаки смогли получить доступ к контейнерам, они могут запустить процесс от root и прописаться в разные системные вызовы, вы его никогда больше не найдете. Даже при полном удалении всех темпов вирусни, вы все равно будете сталкиваться с тем, что система сама будет его тянуть изнутри. wgetом или dcokerом. Проще всего будет удалить сервер и пересоздать все по новой, руководствуясь этими рекомендациями.

    Не рекомендуется светить наружу postgres и использовать внешние подключения. 
    Например, при настройке Grafana лучше всего использовать внутренний хост Docker 
    и указывать внутренний порт postgres, который указан в .env 

---------------------------------------------------------
Общие сведения:
--------------------------------------------------------- 
Сервис состоит из приложения на python, которое подключается к MOEX API и забирает ценовые значения по тикерам фондовой секции котировального списка TQBR. 
Цены записываются в базу данных. Опрос по умолчанию происходит раз в 5 минут. Настройка пока не выносилась в отдельный конфиг и находится внутри исходного кода приложения в модуле app.py в строке  "sleep(300)  # 300 секунд = 5 минут"
Возможно, это будет вынесено отдельно, либо заменено на остановку и запуск конетйнера по заданию cron. 
Я пока не решил как лучше.

Мониторинг разворачивается в Docker контейнерах
   postgres
   grafana
   app

---------------------------------------------------------
Приложение(app):
---------------------------------------------------------

Перед развертыванием рекомендуется настраивать под себя все порты и учетные данные. 
Натройка производится в файле .env 

DB_NAME указываем базу данных для подключения к БД
DB_USER указываем пользователя для подключения к БД
DB_PASSWORD указываем пароль для подключения к БД
DB_DOCKER_HOST указываем название локального хоста докера для БД
DB_DOCKER_PORT указываем внутренний порт в докере для БД
DB_OS_PORT указываем проброшенный порт из контейнера в ОС для БД

GF_SECURITY_ADMIN_USER указываем, какой юзер будет создан при развертывании Grafana
GF_SECURITY_ADMIN_PASSWORD указываем пароль от grafana
GF_DOCKER_PORT указываем внутренний порт Grafana
GF_OS_PORT указываем проброшенный порт Grafana

APP_DOCKER_PORT указываем внутренний порт для приложения
APP_OS_PORT указываем проброшенный порт для приложения

---------------------------------------------------------
Мониторинг(Grafana): 
---------------------------------------------------------

Мониторинг рассчитывает процент значений Null, если таковые имеются в выдаче MOEX API и записывает это значение в базу данных, таблица null_price_percentage. 
На основе нее можно построить несколько типов алертов в Grafana

Реализовано :
    100% ценовых значений по тикерам TQBR равны Null 

В плане
    В течении 2 опросов, цены по 50% от всех тикеров TQBR не обновились


Шаблоны grafana настраиваются пока в ручном режиме, не удается реализовать развертку автоматически.
Но есть способ простого импорта настроек, которые будут находиться в репозитории с приложением в папке 
grafana_templates. После развертывания приложения нужно в браузере указать в адресной строке хостнейм:порт, перейти в графану
ввести логин/пароль, перейти сначала в /connections/add-new-connection и добавить источник postgres. Натроить согласно .env
Если не используете ssl, то нужно отключить в параметрах TLS/SSL Mode выставить Disable
Далее требуется импортировать дашборды. Можно перейти через UI или по линку /dashboard/import 
там можно выбрать Upload dashboard JSON file, укажите те шаблоны, которые лежат в репозитории. Либо вы можете создать полностью свои шаблоны. 
Также может быть так, что потребуется удалить UID от старого дашборда, но я стараюсь убирать их в шаблоне. Но все же: 
Если будет запись вида Datasource b49944e8-46d8-4ab3-bbe3-787d0d328120 was not found
То в json блока в дашборде нужно удалить строчку uid 

"datasource": {
    "type": "grafana-postgresql-datasource",
    "uid": "b49944e8-46d8-4ab3-bbe3-787d0d328120"}

Чтобы осталось только 

"datasource": {
    "type": "grafana-postgresql-datasource"}

Grafana в этом случае перезапросит uid

---------------------------------------------------------
База данных(postgres): 
---------------------------------------------------------

База данных отражена в файле init.db.sql

